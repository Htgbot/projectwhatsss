{
    # Global options
    email admin@whtshtg.lkdevs.com
}

# The domain will be provided via environment variable or hardcoded
{$DOMAIN} {
    # Supabase API Gateway (Kong)
    # Place API routes BEFORE frontend catch-alls to avoid shadowing
    # Realtime (WebSocket) routed directly to container, with path rewrite to /socket/websocket
    handle_path /api/realtime/v1/* {
        rewrite * /socket{path}
        reverse_proxy realtime:4000 {
            header_up Host {host}
            header_up X-Real-IP {remote}
            header_up X-Forwarded-For {remote}
            header_up X-Forwarded-Proto {scheme}
            header_up Upgrade {http.request.header.Upgrade}
            header_up Connection {http.request.header.Connection}
            header_up Sec-WebSocket-Key {http.request.header.Sec-WebSocket-Key}
            header_up Sec-WebSocket-Version {http.request.header.Sec-WebSocket-Version}
            header_up Sec-WebSocket-Extensions {http.request.header.Sec-WebSocket-Extensions}
            header_up Sec-WebSocket-Protocol {http.request.header.Sec-WebSocket-Protocol}
        }
    }

    # All other Supabase APIs via Kong
    handle_path /api/* {
        reverse_proxy kong:8000 {
            header_up Host {host}
            header_up X-Real-IP {remote}
            header_up X-Forwarded-For {remote}
            header_up X-Forwarded-Proto {scheme}
            # WebSocket support
            header_up Upgrade {http.request.header.Upgrade}
            header_up Connection {http.request.header.Connection}
            header_up Sec-WebSocket-Key {http.request.header.Sec-WebSocket-Key}
            header_up Sec-WebSocket-Version {http.request.header.Sec-WebSocket-Version}
            header_up Sec-WebSocket-Extensions {http.request.header.Sec-WebSocket-Extensions}
            header_up Sec-WebSocket-Protocol {http.request.header.Sec-WebSocket-Protocol}
        }
    }

    # Handle functions directly if /api prefix is missing
    handle /functions/* {
        reverse_proxy kong:8000
    }

    # Frontend (after API handlers)
    handle /assets/* {
        reverse_proxy app:8080
    }
    handle / {
        reverse_proxy app:8080
    }
    handle /* {
        reverse_proxy app:8080
    }

    log {
        output file /var/log/caddy/access.log
    }
}
