{
    # Global options
    email admin@whtshtg.lkdevs.com
}

# The domain will be provided via environment variable or hardcoded
{$DOMAIN} {
    # Frontend
    handle / {
        reverse_proxy app:8080
    }
    handle /assets/* {
        reverse_proxy app:8080
    }
    handle /* {
        reverse_proxy app:8080
    }


    # Supabase API Gateway (Kong)
    # Route Realtime directly to the Realtime container to ensure WebSocket stability
    # This more specific route must come BEFORE the generic /api/* route
    # handle_path /api/realtime/v1/* {
    #    reverse_proxy realtime:4000 {
    #        header_up Host {host}
    #        header_up X-Real-IP {remote}
    #        header_up X-Forwarded-For {remote}
    #        header_up X-Forwarded-Proto {scheme}
    #        header_up Upgrade {http.request.header.Upgrade}
    #        header_up Connection {http.request.header.Connection}
    #        header_up Sec-WebSocket-Key {http.request.header.Sec-WebSocket-Key}
    #        header_up Sec-WebSocket-Version {http.request.header.Sec-WebSocket-Version}
    #        header_up Sec-WebSocket-Extensions {http.request.header.Sec-WebSocket-Extensions}
    #        header_up Sec-WebSocket-Protocol {http.request.header.Sec-WebSocket-Protocol}
    #    }
    # }

    handle_path /api/* {
        reverse_proxy kong:8000 {
            header_up Host {host}
            header_up X-Real-IP {remote}
            header_up X-Forwarded-For {remote}
            header_up X-Forwarded-Proto {scheme}
            
            # WebSocket support
            header_up Upgrade {http.request.header.Upgrade}
            header_up Connection {http.request.header.Connection}
            header_up Sec-WebSocket-Key {http.request.header.Sec-WebSocket-Key}
            header_up Sec-WebSocket-Version {http.request.header.Sec-WebSocket-Version}
            header_up Sec-WebSocket-Extensions {http.request.header.Sec-WebSocket-Extensions}
            header_up Sec-WebSocket-Protocol {http.request.header.Sec-WebSocket-Protocol}
        }
    }

    # Handle functions directly if /api prefix is missing
    handle /functions/* {
        reverse_proxy kong:8000
    }
    
    # Direct access to functions if Kong doesn't handle it or for simplicity
    # But usually Kong handles /functions/v1/...
    
    log {
        output file /var/log/caddy/access.log
    }
}
